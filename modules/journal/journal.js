import tags from"../../journal/generated/tags.js";import entries from"../../journal/generated/entries.js";import{animate,clearPage,contractHeroImage,expandHeroImage,loadImage,renderHeader}from"../shared/common.js";let backButtonUsesHistoryApi=!1;async function render(t){var n=document.querySelector(".container .page"),a=document.createElement("main");if(a.id="journal",a.classList.add("content"),t.startsWith("#journal/")){await contractHeroImage();t=t.split("/"),t=(2!==t.length&&window.location.replace("/404.html"),t[1]),t=await fetch("journal/"+t);t.ok||window.location.replace("/404.html");var r,i,l,t=(new DOMParser).parseFromString(await t.text(),"text/html"),t=(document.title=t.title,t.querySelector("article.journal-entry-container"));for(r of t.querySelectorAll("img")){var o=new URL(r.src);r.src="/journal"+o.pathname,await loadImage(r.src)}for(i of t.querySelectorAll("video")){var d,s=i.cloneNode(!1);for(d of i.querySelectorAll("source")){var c="/journal"+new URL(d.src).pathname,m=d.cloneNode(!1);m.src=c,s.appendChild(m)}i.replaceWith(s)}t.querySelector("a.btn-back").onclick=function(){return!backButtonUsesHistoryApi||(window.history.back(),backButtonUsesHistoryApi=!1)};let e=0;for(l of t.children)l.style.opacity="0",l.style.animationFillMode="forwards",l.style.animationDuration="1s",animate(l,"simple-fade-in",100*e++),e=Math.min(e,8);a.appendChild(t),n.replaceChildren(a)}else n.replaceChildren(a),await Promise.all(entries.slice(0,5).map(e=>loadImage(e.cover))),await renderHeader(a,"Journal"),renderTags(a),renderEntries(a)}async function clear(){await clearPage(),await expandHeroImage()}function toggleTagClicked(n,e){var t=document.getElementById("journal");let a=JSON.parse(sessionStorage.tags);var r=Object.values(a).reduce((e,t)=>e&&t,!0);if(r)for(var i of Object.keys(a))i!==n&&(toggleTag(document.getElementById("tag-"+i.replaceAll(" ","")),!1),a[i]=!1);else if((()=>{for(var[e,t]of Object.entries(a)){if(e===n){if(t)continue;return!1}if(t)return!1}return!0})())for(var l of Object.keys(a))toggleTag(document.getElementById("tag-"+l.replaceAll(" ","")),!0),a[l]=!0;else{r=!a[n];toggleTag(e,a[n]=r)}sessionStorage.tags=JSON.stringify(a),renderEntries(t,!0)}function toggleTag(e,t){e.ariaPressed=t,e.style.animation="none",e.style.opacity=t?1:.5}function renderTags(e){let r;r=sessionStorage.tags?JSON.parse(sessionStorage.tags):{};var i=[],l=document.createElement("div"),t=(l.classList.add("tag-list"),l.role="list",document.createElement("img")),n=(t.src="modules/journal/rss.png",t.style.height="inherit",document.createElement("a"));n.href="journal/generated/rss.xml",n.classList.add("feed-icon"),n.appendChild(t);let o=0;i.push(animate(n,"simple-fade-in",250+100*o++)),l.appendChild(n);for(let[n,a]of Object.entries(tags)){let t=document.createElement("span");t.classList.add("tag"),t.role="button listitem",t.tabIndex=0,t.innerText=n,t.id="tag-"+n.replaceAll(" ","");var d=document.createElement("span");d.innerText=a,t.appendChild(d);let e;n in r||(r[n]=!0),r[n]?(e="simple-fade-in",t.ariaPressed=!0):(e="simple-fade-in-half-way",t.ariaPressed=!1),t.onclick=function(){toggleTagClicked(n,t)},t.addEventListener("keydown",function(e){"Enter"===e.key&&toggleTagClicked(n,t)}),i.push(animate(t,e,250+100*o++)),l.appendChild(t)}return sessionStorage.tags=JSON.stringify(r),e.appendChild(l),i}function renderEntries(e,t=!1){let y=JSON.parse(sessionStorage.tags),v=document.createElement("div");v.id="journal-entry-list";var t=function t(n,a,e){var r,i=[],l=e?0:1;let o=0;for(;o<8&&0!==n.length;){var d=n.shift();if(d.tags.reduce((e,t)=>e||y[t],!1)){var s,c=document.createElement("article"),m=(c.style.backgroundImage=`url('${d.cover}')`,c.classList.add("journal-entry"),document.createElement("div"));(f=document.createElement("div")).classList.add("entry-header");(g=document.createElement("span")).classList.add("entry-title"),g.textContent=d.title,f.appendChild(g);var u=document.createElement("div");u.classList.add("entry-tag-row");for(s of d.tags){var p=document.createElement("span");p.classList.add("entry-tag"),p.textContent=s,u.appendChild(p)}f.appendChild(u),m.appendChild(f);(g=document.createElement("div")).classList.add("entry-date-time");var g,f=document.createElement("span"),h=new Date(d.published).toLocaleString("en-AU",{year:"numeric",month:"long",day:"numeric"});f.textContent=h,g.appendChild(f),(h=document.createElement("span")).setHTMLUnsafe("&bull;"),g.appendChild(h),(f=document.createElement("span")).textContent=d.minutes+" minute read",g.appendChild(f),m.appendChild(g),(h=document.createElement("div")).classList.add("entry-preview"),h.textContent=d.preview,m.appendChild(h),c.appendChild(m),(f=document.createElement("a")).href="#journal/"+d.document,f.onclick=function(){return backButtonUsesHistoryApi=!0},f.appendChild(c),i.push(animate(c,"simple-fade-in",100*l*o++)),a.appendChild(f)}}return 0!==n.length&&((e=document.createElement("div")).classList.add("show-older-container"),(r=document.createElement("a")).role="button",r.tabIndex=0,r.classList.add("show-older-button"),r.innerText="Show older",r.onclick=function(e){e.target.remove(),t(n,a,!1)},r.addEventListener("keydown",function(e){"Enter"===e.key&&(e.target.remove(),t(n,a,!1))}),e.appendChild(r),v.appendChild(e)),i}([...entries],v,t),n=document.getElementById("journal-entry-list");return n&&n.remove(),e.appendChild(v),t}export{render,clear};